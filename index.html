<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three Kingdoms Campaign</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f0e6d2;
            color: #333;
            text-align: center;
            background-image: url('https://img.freepik.com/free-vector/chinese-pattern-background_53876-90035.jpg');
            background-size: cover;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        h1, h2, h3 {
            color: #8B0000;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        .screen {
            display: none;
        }
        .active-screen {
            display: block;
        }
        button {
            background-color: #8B0000;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover {
            background-color: #A52A2A;
            transform: scale(1.05);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .kingdom-select {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .kingdom {
            width: 30%;
            padding: 15px;
            margin: 10px 0;
            border: 3px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .kingdom:hover {
            transform: scale(1.03);
        }
        .kingdom.selected {
            border-color: gold;
            box-shadow: 0 0 15px gold;
        }
        #wei { background-color: rgba(0, 0, 139, 0.1); }
        #shu { background-color: rgba(139, 0, 0, 0.1); }
        #wu { background-color: rgba(0, 100, 0, 0.1); }
        .campaign-map {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .location {
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(200, 200, 200, 0.5);
            transition: all 0.3s;
        }
        .location.available {
            background-color: rgba(144, 238, 144, 0.6);
            cursor: pointer;
        }
        .location.available:hover {
            transform: scale(1.05);
        }
        .location.current {
            background-color: rgba(255, 215, 0, 0.7);
            font-weight: bold;
        }
        .location.completed {
            background-color: rgba(173, 216, 230, 0.6);
        }
        .location.enemy {
            background-color: rgba(255, 99, 71, 0.6);
        }
        .battle-field {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .army {
            width: 48%;
            min-width: 300px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        #player-army { background-color: rgba(0, 255, 0, 0.1); }
        #enemy-army { background-color: rgba(255, 0, 0, 0.1); }
        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .stat-box {
            width: 45%;
            min-width: 300px;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.7);
        }
        .soldier-type {
            margin: 8px 0;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
        }
        .soldier-input {
            width: 60px;
            text-align: center;
            margin: 0 5px;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            margin: 10px 0;
        }
        .campaign-info {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 15px 0;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
        }
        .victory { color: blue; font-weight: bold; }
        .defeat { color: red; font-weight: bold; }
        .reinforcement { color: green; font-weight: bold; }
        .highlight { font-weight: bold; color: #8B0000; }
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted black;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        @media (max-width: 768px) {
            .kingdom {
                width: 100%;
            }
            .army, .stat-box {
                width: 100%;
            }
            .campaign-map {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active-screen">
            <h1>三国演义: 战争战役 (Three Kingdoms: War Campaign)</h1>
            <button onclick="showScreen('kingdom-selection')">开始新游戏 (New Game)</button>
            <button onclick="showScreen('instructions')">游戏说明 (Instructions)</button>
        </div>

        <!-- Kingdom Selection Screen -->
        <div id="kingdom-selection" class="screen">
            <h2>选择你的势力 (Choose Your Kingdom)</h2>
            <div class="kingdom-select">
                <div class="kingdom" id="wei" onclick="selectKingdom('wei')">
                    <h3>魏国 (Wei)</h3>
                    <p>曹操的势力</p>
                    <p><span class="highlight">优势:</span> 强大的骑兵 (+20% cavalry effectiveness)</p>
                    <p><span class="highlight">增援:</span> 骑兵为主</p>
                    <p><span class="highlight">特殊技能:</span> 骑兵冲锋 (Cavalry Charge)</p>
                </div>
                <div class="kingdom" id="shu" onclick="selectKingdom('shu')">
                    <h3>蜀国 (Shu)</h3>
                    <p>刘备的势力</p>
                    <p><span class="highlight">优势:</span> 精锐的步兵 (+20% infantry effectiveness)</p>
                    <p><span class="highlight">增援:</span> 步兵为主</p>
                    <p><span class="highlight">特殊技能:</span> 连弩齐射 (Repeating Crossbows)</p>
                </div>
                <div class="kingdom" id="wu" onclick="selectKingdom('wu')">
                    <h3>吴国 (Wu)</h3>
                    <p>孙权的势力</p>
                    <p><span class="highlight">优势:</span> 强大的弓箭手 (+20% archer effectiveness)</p>
                    <p><span class="highlight">增援:</span> 弓箭手为主</p>
                    <p><span class="highlight">特殊技能:</span> 火攻战术 (Fire Attack)</p>
                </div>
            </div>
            <button id="start-campaign-btn" disabled onclick="startCampaign()">开始战役 (Start Campaign)</button>
            <button onclick="showScreen('main-menu')">返回主菜单 (Back to Menu)</button>
        </div>

        <!-- Campaign Map Screen -->
        <div id="campaign-map-screen" class="screen">
            <h2>战役地图 (Campaign Map)</h2>
            <div class="campaign-info">
                <div>势力: <span id="campaign-kingdom-name">魏国 (Wei)</span></div>
                <div>天数: <span id="campaign-day">1</span></div>
                <div>战斗: <span id="battles-completed">0</span>/<span id="total-battles">8</span></div>
                <div>胜利: <span id="victories">0</span></div>
                <div>失败: <span id="defeats">0</span></div>
            </div>
            
            <div class="campaign-map" id="campaign-map-container">
                <!-- Locations will be added dynamically -->
            </div>
            
            <button onclick="endCampaign()">结束战役 (End Campaign)</button>
            <button onclick="showScreen('main-menu')">返回主菜单 (Back to Menu)</button>
        </div>

        <!-- Battle Screen -->
        <div id="battle-screen" class="screen">
            <h2 id="battle-title">战斗 (Battle)</h2>
            <div class="campaign-info">
                <div>地点: <span id="battle-location-name">虎牢关 (Hulao Pass)</span></div>
                <div>天数: <span id="battle-day">1</span></div>
                <div>回合: <span id="battle-round">1</span></div>
                <div>敌人: <span id="enemy-kingdom-name">魏国 (Wei)</span></div>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <h3>你的军队 (Your Army)</h3>
                    <p>总兵力: <span id="player-total-troops">10000</span></p>
                    <div class="soldier-type">
                        <span class="tooltip">步兵 (Infantry)<span class="tooltiptext">Strong against cavalry, weak against archers</span></span>:
                        <span id="player-infantry">4000</span>
                    </div>
                    <div class="soldier-type">
                        <span class="tooltip">骑兵 (Cavalry)<span class="tooltiptext">Strong against archers, weak against infantry</span></span>:
                        <span id="player-cavalry">3000</span>
                    </div>
                    <div class="soldier-type">
                        <span class="tooltip">弓箭手 (Archers)<span class="tooltiptext">Strong against infantry, weak against cavalry</span></span>:
                        <span id="player-archers">3000</span>
                    </div>
                    <p>士气: <span id="player-morale">100</span></p>
                </div>
                
                <div class="stat-box">
                    <h3>敌军 (Enemy Army)</h3>
                    <p>总兵力: <span id="enemy-total-troops">10000</span></p>
                    <div class="soldier-type">
                        步兵 (Infantry): <span id="enemy-infantry">4000</span>
                    </div>
                    <div class="soldier-type">
                        骑兵 (Cavalry): <span id="enemy-cavalry">3000</span>
                    </div>
                    <div class="soldier-type">
                        弓箭手 (Archers): <span id="enemy-archers">3000</span>
                    </div>
                    <p>士气: <span id="enemy-morale">100</span></p>
                </div>
            </div>
            
            <div class="battle-field">
                <div class="army" id="player-army">
                    <h3>你的将军 (Your Generals)</h3>
                    <div id="player-generals"></div>
                    <h3>部署军队 (Deploy Troops)</h3>
                    <div class="soldier-type">
                        步兵 (Infantry): <input type="number" min="0" class="soldier-input" id="deploy-infantry" value="1000">
                        /<span id="max-infantry">4000</span>
                    </div>
                    <div class="soldier-type">
                        骑兵 (Cavalry): <input type="number" min="0" class="soldier-input" id="deploy-cavalry" value="1000">
                        /<span id="max-cavalry">3000</span>
                    </div>
                    <div class="soldier-type">
                        弓箭手 (Archers): <input type="number" min="0" class="soldier-input" id="deploy-archers" value="1000">
                        /<span id="max-archers">3000</span>
                    </div>
                </div>
                
                <div class="army" id="enemy-army">
                    <h3>敌军将军 (Enemy Generals)</h3>
                    <div id="enemy-generals"></div>
                    <h3>敌军部署 (Enemy Deployment)</h3>
                    <div class="soldier-type">
                        步兵 (Infantry): <span id="enemy-deploy-infantry">1000</span>
                    </div>
                    <div class="soldier-type">
                        骑兵 (Cavalry): <span id="enemy-deploy-cavalry">1000</span>
                    </div>
                    <div class="soldier-type">
                        弓箭手 (Archers): <span id="enemy-deploy-archers">1000</span>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button onclick="battleAction('attack')">攻击 (Attack)</button>
                <button onclick="battleAction('defend')">防御 (Defend)</button>
                <button onclick="battleAction('special')">特殊技能 (Special)</button>
                <button onclick="battleAction('retreat')">撤退 (Retreat)</button>
            </div>
            
            <h3>战斗记录 (Battle Log)</h3>
            <div class="log" id="battle-log"></div>
        </div>

        <!-- Campaign End Screen -->
        <div id="campaign-end-screen" class="screen">
            <h2 id="campaign-result-title">战役结果 (Campaign Result)</h2>
            <div id="campaign-result-details">
                <!-- Results will be shown here -->
            </div>
            <button onclick="showScreen('main-menu')">返回主菜单 (Back to Menu)</button>
        </div>

        <!-- Instructions Screen -->
        <div id="instructions" class="screen">
            <h2>游戏说明 (Game Instructions)</h2>
            <div style="text-align: left; max-width: 800px; margin: 0 auto;">
                <h3>游戏概述 (Game Overview)</h3>
                <p>这是一个基于三国演义的战略游戏。你将选择一个势力，并在多个历史战场上与敌人作战。</p>
                <p>This is a strategy game based on Romance of the Three Kingdoms. You will choose a kingdom and fight enemies across multiple historical battlefields.</p>
                
                <h3>军队类型 (Army Types)</h3>
                <ul>
                    <li><strong>步兵 (Infantry)</strong>: 克制骑兵，被弓箭手克制 | Strong against cavalry, weak against archers</li>
                    <li><strong>骑兵 (Cavalry)</strong>: 克制弓箭手，被步兵克制 | Strong against archers, weak against infantry</li>
                    <li><strong>弓箭手 (Archers)</strong>: 克制步兵，被骑兵克制 | Strong against infantry, weak against cavalry</li>
                </ul>
                
                <h3>战斗指令 (Battle Commands)</h3>
                <ul>
                    <li><strong>攻击 (Attack)</strong>: 主动攻击敌人 | Launch an attack against the enemy</li>
                    <li><strong>防御 (Defend)</strong>: 减少受到的伤害 | Reduce damage taken but deal less damage</li>
                    <li><strong>特殊技能 (Special)</strong>: 使用你的势力的特殊能力 | Use your kingdom's special ability</li>
                    <li><strong>撤退 (Retreat)</strong>: 撤退并损失部分军队 | Retreat and lose some troops</li>
                </ul>
                
                <h3>战役流程 (Campaign Flow)</h3>
                <p>你需要完成多个历史战役，每个战役后你的军队会保留。胜利会带来增援，失败会减少你的军队。</p>
                <p>You must complete multiple historical battles. Your army persists between battles. Victories bring reinforcements, defeats reduce your army.</p>
            </div>
            <button onclick="showScreen('main-menu')">返回主菜单 (Back to Menu)</button>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            selectedKingdom: null,
            campaignDay: 1,
            battlesCompleted: 0,
            victories: 0,
            defeats: 0,
            currentBattle: null,
            campaignLocations: [
                { id: 1, name: "虎牢关 (Hulao Pass)", enemy: "wei", difficulty: 1, completed: false },
                { id: 2, name: "长坂坡 (Changban Slope)", enemy: "wei", difficulty: 2, completed: false },
                { id: 3, name: "赤壁 (Red Cliffs)", enemy: "wu", difficulty: 3, completed: false },
                { id: 4, name: "夷陵 (Yiling)", enemy: "wu", difficulty: 2, completed: false },
                { id: 5, name: "合肥 (Hefei)", enemy: "wei", difficulty: 2, completed: false },
                { id: 6, name: "荆州 (Jingzhou)", enemy: "shu", difficulty: 2, completed: false },
                { id: 7, name: "汉中 (Hanzhong)", enemy: "shu", difficulty: 3, completed: false },
                { id: 8, name: "五丈原 (Wuzhang Plains)", enemy: "shu", difficulty: 4, completed: false }
            ],
            playerTroops: {
                infantry: 4000,
                cavalry: 3000,
                archers: 3000,
                morale: 100
            },
            enemyTroops: null,
            deployedTroops: {
                infantry: 1000,
                cavalry: 1000,
                archers: 1000
            },
            enemyDeployedTroops: null,
            battleRound: 1
        };

        // Kingdom data
        const kingdoms = {
            wei: {
                name: "魏国 (Wei)",
                generals: ["曹操 (Cao Cao)", "司马懿 (Sima Yi)", "张辽 (Zhang Liao)", "许褚 (Xu Chu)", "典韦 (Dian Wei)"],
                special: "骑兵冲锋 (Cavalry Charge)",
                bonus: { cavalry: 1.2 },
                reinforcement: { infantry: 0.2, cavalry: 0.6, archers: 0.2 }
            },
            shu: {
                name: "蜀国 (Shu)",
                generals: ["刘备 (Liu Bei)", "诸葛亮 (Zhuge Liang)", "关羽 (Guan Yu)", "张飞 (Zhang Fei)", "赵云 (Zhao Yun)"],
                special: "连弩齐射 (Repeating Crossbows)",
                bonus: { infantry: 1.2 },
                reinforcement: { infantry: 0.6, cavalry: 0.2, archers: 0.2 }
            },
            wu: {
                name: "吴国 (Wu)",
                generals: ["孙权 (Sun Quan)", "周瑜 (Zhou Yu)", "吕蒙 (Lü Meng)", "陆逊 (Lu Xun)", "太史慈 (Taishi Ci)"],
                special: "火攻战术 (Fire Attack)",
                bonus: { archers: 1.2 },
                reinforcement: { infantry: 0.2, cavalry: 0.2, archers: 0.6 }
            }
        };

        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active-screen');
            });
            document.getElementById(screenId).classList.add('active-screen');
            
            if (screenId === 'campaign-map-screen') {
                renderCampaignMap();
            }
        }

        // Kingdom selection
        function selectKingdom(kingdom) {
            gameState.selectedKingdom = kingdom;
            document.getElementById('start-campaign-btn').disabled = false;
            
            // Highlight selected kingdom
            document.querySelectorAll('.kingdom').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById(kingdom).classList.add('selected');
        }

        // Start campaign
        function startCampaign() {
            // Reset campaign state
            gameState.campaignDay = 1;
            gameState.battlesCompleted = 0;
            gameState.victories = 0;
            gameState.defeats = 0;
            gameState.campaignLocations.forEach(loc => loc.completed = false);
            
            // Initialize player troops
            gameState.playerTroops = {
                infantry: 4000,
                cavalry: 3000,
                archers: 3000,
                morale: 100
            };
            
            // Update UI
            document.getElementById('campaign-kingdom-name').textContent = kingdoms[gameState.selectedKingdom].name;
            document.getElementById('campaign-day').textContent = gameState.campaignDay;
            document.getElementById('battles-completed').textContent = gameState.battlesCompleted;
            document.getElementById('victories').textContent = gameState.victories;
            document.getElementById('defeats').textContent = gameState.defeats;
            document.getElementById('total-battles').textContent = gameState.campaignLocations.length;
            
            showScreen('campaign-map-screen');
        }

        // Render campaign map
        function renderCampaignMap() {
            const container = document.getElementById('campaign-map-container');
            container.innerHTML = '';
            
            gameState.campaignLocations.forEach(location => {
                const locEl = document.createElement('div');
                locEl.className = 'location';
                
                if (location.completed) {
                    locEl.classList.add('completed');
                    locEl.textContent = `${location.name} (已完成)`;
                } else if (gameState.battlesCompleted === location.id - 1) {
                    locEl.classList.add('current');
                    locEl.textContent = `${location.name} (当前战斗)`;
                    locEl.onclick = () => startBattle(location.id);
                } else if (gameState.battlesCompleted > location.id - 1) {
                    locEl.classList.add('completed');
                    locEl.textContent = `${location.name} (已完成)`;
                } else {
                    locEl.classList.add('enemy');
                    locEl.textContent = `${location.name} (敌军控制)`;
                }
                
                container.appendChild(locEl);
            });
        }

        // Start a battle
        function startBattle(locationId) {
            const location = gameState.campaignLocations.find(loc => loc.id === locationId);
            gameState.currentBattle = location;
            
            // Initialize enemy troops based on difficulty
            const baseTroops = location.difficulty * 2000;
            gameState.enemyTroops = {
                infantry: Math.floor(baseTroops * 0.4),
                cavalry: Math.floor(baseTroops * 0.3),
                archers: Math.floor(baseTroops * 0.3),
                morale: 100
            };
            
            // Initialize deployments
            gameState.deployedTroops = {
                infantry: Math.min(1000, gameState.playerTroops.infantry),
                cavalry: Math.min(1000, gameState.playerTroops.cavalry),
                archers: Math.min(1000, gameState.playerTroops.archers)
            };
            
            determineEnemyDeployment();
            gameState.battleRound = 1;
            
            // Update UI
            document.getElementById('battle-title').textContent = `战斗: ${location.name}`;
            document.getElementById('battle-location-name').textContent = location.name;
            document.getElementById('battle-day').textContent = gameState.campaignDay;
            document.getElementById('battle-round').textContent = gameState.battleRound;
            document.getElementById('enemy-kingdom-name').textContent = kingdoms[location.enemy].name;
            
            // Update troop displays
            updateTroopDisplays();
            
            // Display generals
            displayGenerals();
            
            // Clear battle log
            document.getElementById('battle-log').innerHTML = '';
            addToLog(`战役第 ${gameState.campaignDay} 天: ${location.name} 战斗开始!`);
            addToLog(`对抗 ${kingdoms[location.enemy].name} 军队`);
            
            showScreen('battle-screen');
        }

        // Determine enemy deployment
        function determineEnemyDeployment() {
            const totalEnemy = calculateTotalTroops(gameState.enemyTroops);
            const deployRatio = 0.3 + Math.random() * 0.2; // Deploy 30-50% of forces
            
            gameState.enemyDeployedTroops = {
                infantry: Math.max(100, Math.min(
                    Math.floor(gameState.enemyTroops.infantry * deployRatio),
                    gameState.enemyTroops.infantry
                )),
                cavalry: Math.max(100, Math.min(
                    Math.floor(gameState.enemyTroops.cavalry * deployRatio),
                    gameState.enemyTroops.cavalry
                )),
                archers: Math.max(100, Math.min(
                    Math.floor(gameState.enemyTroops.archers * deployRatio),
                    gameState.enemyTroops.archers
                ))
            };
            
            // Update UI
            document.getElementById('enemy-deploy-infantry').textContent = gameState.enemyDeployedTroops.infantry;
            document.getElementById('enemy-deploy-cavalry').textContent = gameState.enemyDeployedTroops.cavalry;
            document.getElementById('enemy-deploy-archers').textContent = gameState.enemyDeployedTroops.archers;
        }

        // Update troop displays
        function updateTroopDisplays() {
            // Player troops
            document.getElementById('player-total-troops').textContent = calculateTotalTroops(gameState.playerTroops);
            document.getElementById('player-infantry').textContent = gameState.playerTroops.infantry;
            document.getElementById('player-cavalry').textContent = gameState.playerTroops.cavalry;
            document.getElementById('player-archers').textContent = gameState.playerTroops.archers;
            document.getElementById('player-morale').textContent = gameState.playerTroops.morale;
            
            // Enemy troops
            document.getElementById('enemy-total-troops').textContent = calculateTotalTroops(gameState.enemyTroops);
            document.getElementById('enemy-infantry').textContent = gameState.enemyTroops.infantry;
            document.getElementById('enemy-cavalry').textContent = gameState.enemyTroops.cavalry;
            document.getElementById('enemy-archers').textContent = gameState.enemyTroops.archers;
            document.getElementById('enemy-morale').textContent = gameState.enemyTroops.morale;
            
            // Deployment inputs
            document.getElementById('deploy-infantry').value = gameState.deployedTroops.infantry;
            document.getElementById('deploy-cavalry').value = gameState.deployedTroops.cavalry;
            document.getElementById('deploy-archers').value = gameState.deployedTroops.archers;
            
            document.getElementById('max-infantry').textContent = gameState.playerTroops.infantry;
            document.getElementById('max-cavalry').textContent = gameState.playerTroops.cavalry;
            document.getElementById('max-archers').textContent = gameState.playerTroops.archers;
        }

        // Display generals
        function displayGenerals() {
            const playerGeneralsEl = document.getElementById('player-generals');
            playerGeneralsEl.innerHTML = '';
            kingdoms[gameState.selectedKingdom].generals.forEach(general => {
                const generalEl = document.createElement('div');
                generalEl.className = 'general';
                generalEl.textContent = general;
                playerGeneralsEl.appendChild(generalEl);
            });
            
            const enemyGeneralsEl = document.getElementById('enemy-generals');
            enemyGeneralsEl.innerHTML = '';
            kingdoms[gameState.currentBattle.enemy].generals.forEach(general => {
                const generalEl = document.createElement('div');
                generalEl.className = 'general';
                generalEl.textContent = general;
                enemyGeneralsEl.appendChild(generalEl);
            });
        }

        // Calculate total troops
        function calculateTotalTroops(troops) {
            return troops.infantry + troops.cavalry + troops.archers;
        }

        // Battle actions
        function battleAction(action) {
            // Get deployed troops from inputs
            gameState.deployedTroops = {
                infantry: parseInt(document.getElementById('deploy-infantry').value) || 0,
                cavalry: parseInt(document.getElementById('deploy-cavalry').value) || 0,
                archers: parseInt(document.getElementById('deploy-archers').value) || 0
            };
            
            // Validate deployment
            if (calculateTotalTroops(gameState.deployedTroops) === 0) {
                addToLog("错误: 你没有部署任何军队!");
                return;
            }
            
            let playerDamage = 0;
            let enemyDamage = 0;
            
            switch (action) {
                case 'attack':
                    addToLog(`第 ${gameState.battleRound} 回合: 你发动攻击!`);
                    
                    // Player attacks
                    playerDamage += calculateTroopDamage(gameState.deployedTroops.infantry, 'infantry', gameState.enemyDeployedTroops, true);
                    playerDamage += calculateTroopDamage(gameState.deployedTroops.cavalry, 'cavalry', gameState.enemyDeployedTroops, true);
                    playerDamage += calculateTroopDamage(gameState.deployedTroops.archers, 'archers', gameState.enemyDeployedTroops, true);
                    
                    // Enemy counterattacks
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.infantry, 'infantry', gameState.deployedTroops, false);
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.cavalry, 'cavalry', gameState.deployedTroops, false);
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.archers, 'archers', gameState.deployedTroops, false);
                    break;
                    
                case 'defend':
                    addToLog(`第 ${gameState.battleRound} 回合: 你选择防御!`);
                    
                    // Enemy attacks with reduced damage
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.infantry, 'infantry', gameState.deployedTroops, false);
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.cavalry, 'cavalry', gameState.deployedTroops, false);
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.archers, 'archers', gameState.deployedTroops, false);
                    enemyDamage *= 0.6; // Defense reduces damage
                    
                    // Morale bonus for defending
                    gameState.playerTroops.morale = Math.min(100, gameState.playerTroops.morale + 3);
                    gameState.enemyTroops.morale = Math.max(0, gameState.enemyTroops.morale - 2);
                    break;
                    
                case 'special':
                    addToLog(`第 ${gameState.battleRound} 回合: 你使用 ${kingdoms[gameState.selectedKingdom].special}!`);
                    
                    // Special attack based on kingdom
                    if (gameState.selectedKingdom === 'wei') {
                        // Wei cavalry charge
                        const cavalryDamage = gameState.deployedTroops.cavalry * (1.5 + Math.random()) * kingdoms.wei.bonus.cavalry;
                        playerDamage += cavalryDamage;
                        addToLog(`骑兵冲锋造成 ${Math.floor(cavalryDamage)} 伤害!`);
                    } else if (gameState.selectedKingdom === 'shu') {
                        // Shu repeating crossbows
                        const archerDamage = gameState.deployedTroops.archers * (1.2 + Math.random()) * kingdoms.shu.bonus.infantry;
                        playerDamage += archerDamage;
                        addToLog(`连弩齐射造成 ${Math.floor(archerDamage)} 伤害!`);
                    } else if (gameState.selectedKingdom === 'wu') {
                        // Wu fire attack
                        const fireDamage = (gameState.deployedTroops.infantry + gameState.deployedTroops.cavalry + gameState.deployedTroops.archers) * 
                                          (0.8 + Math.random() * 0.4) * kingdoms.wu.bonus.archers;
                        playerDamage += fireDamage;
                        gameState.enemyTroops.morale = Math.max(0, gameState.enemyTroops.morale - 10);
                        addToLog(`火攻战术造成 ${Math.floor(fireDamage)} 伤害并降低敌军士气!`);
                    }
                    
                    // Enemy still counterattacks
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.infantry, 'infantry', gameState.deployedTroops, false);
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.cavalry, 'cavalry', gameState.deployedTroops, false);
                    enemyDamage += calculateTroopDamage(gameState.enemyDeployedTroops.archers, 'archers', gameState.deployedTroops, false);
                    
                    // Morale bonus for special
                    gameState.playerTroops.morale = Math.min(100, gameState.playerTroops.morale + 5);
                    break;
                    
                case 'retreat':
                    const retreatLoss = Math.floor(calculateTotalTroops(gameState.deployedTroops) * 0.3);
                    
                    // Distribute losses
                    for (const type in gameState.deployedTroops) {
                        const loss = Math.floor(gameState.deployedTroops[type] * 0.3);
                        gameState.playerTroops[type] = Math.max(0, gameState.playerTroops[type] - loss);
                    }
                    
                    addToLog(`你选择撤退，损失了 ${retreatLoss} 兵力`);
                    
                    // Morale changes
                    gameState.playerTroops.morale = Math.max(0, gameState.playerTroops.morale - 10);
                    gameState.enemyTroops.morale = Math.min(100, gameState.enemyTroops.morale + 5);
                    
                    endBattle(false);
                    return;
            }
            
            // Apply damage
            applyDamage(playerDamage, enemyDamage);
            
            // Next round
            gameState.battleRound++;
            document.getElementById('battle-round').textContent = gameState.battleRound;
            
            // Check battle end
            checkBattleEnd();
        }

        // Calculate troop damage
        function calculateTroopDamage(attackerCount, attackerType, defenderTroops, isPlayerAttacking) {
            if (attackerCount <= 0) return 0;
            
            // Determine which defender type to attack
            let defenderType;
            const rand = Math.random();
            if (rand < 0.6) defenderType = attackerType; // 60% same type
            else if (rand < 0.8) { // 20% weak against
                if (attackerType === 'infantry') defenderType = 'archers';
                else if (attackerType === 'cavalry') defenderType = 'infantry';
                else defenderType = 'cavalry';
            } else { // 20% strong against
                if (attackerType === 'infantry') defenderType = 'cavalry';
                else if (attackerType === 'cavalry') defenderType = 'archers';
                else defenderType = 'infantry';
            }
            
            const defenderCount = defenderTroops[defenderType];
            if (defenderCount <= 0) return 0;
            
            // Base damage
            let damage = attackerCount * (0.5 + Math.random() * 0.5);
            
            // Apply effectiveness
            damage *= getEffectiveness(attackerType, defenderType);
            
            // Apply kingdom bonus
            const kingdom = isPlayerAttacking ? gameState.selectedKingdom : gameState.currentBattle.enemy;
            if (kingdoms[kingdom].bonus[attackerType]) {
                damage *= kingdoms[kingdom].bonus[attackerType];
            }
            
            // Apply morale effect
            const morale = isPlayerAttacking ? gameState.playerTroops.morale : gameState.enemyTroops.morale;
            damage *= (morale / 100);
            
            // Random factor
            damage *= 0.8 + Math.random() * 0.4;
            
            // Log the attack
            const attackerName = isPlayerAttacking ? "你的" : "敌军";
            const defenderName = isPlayerAttacking ? "敌军" : "你的";
            addToLog(`${attackerName} ${attackerType} 攻击 ${defenderName} ${defenderType}, 造成 ${Math.floor(damage)} 伤害`);
            
            return Math.floor(damage);
        }

        // Get effectiveness multiplier
        function getEffectiveness(attackerType, defenderType) {
            if (attackerType === 'infantry' && defenderType === 'cavalry') return 1.5;
            if (attackerType === 'cavalry' && defenderType === 'archers') return 1.5;
            if (attackerType === 'archers' && defenderType === 'infantry') return 1.5;
            if (attackerType === 'cavalry' && defenderType === 'infantry') return 0.7;
            if (attackerType === 'archers' && defenderType === 'cavalry') return 0.7;
            if (attackerType === 'infantry' && defenderType === 'archers') return 0.7;
            return 1.0;
        }

        // Apply damage to troops
        function applyDamage(playerDamage, enemyDamage) {
            // Distribute player damage to enemy troops
            distributeDamage(gameState.enemyTroops, gameState.enemyDeployedTroops, enemyDamage);
            
            // Distribute enemy damage to player troops
            distributeDamage(gameState.playerTroops, gameState.deployedTroops, playerDamage);
            
            // Morale changes based on damage ratio
            const damageRatio = playerDamage / Math.max(1, enemyDamage);
            if (damageRatio > 1.2) {
                gameState.playerTroops.morale = Math.min(100, gameState.playerTroops.morale + 5);
                gameState.enemyTroops.morale = Math.max(0, gameState.enemyTroops.morale - 5);
                addToLog("你的军队士气上升!");
            } else if (damageRatio < 0.8) {
                gameState.playerTroops.morale = Math.max(0, gameState.playerTroops.morale - 5);
                gameState.enemyTroops.morale = Math.min(100, gameState.enemyTroops.morale + 5);
                addToLog("敌军士气上升!");
            }
            
            // Update UI
            updateTroopDisplays();
            determineEnemyDeployment();
        }

        // Distribute damage proportionally
        function distributeDamage(totalTroops, deployedTroops, totalDamage) {
            const totalDeployed = calculateTotalTroops(deployedTroops);
            if (totalDeployed <= 0) return;
            
            const damageRatio = totalDamage / totalDeployed;
            
            for (const type in deployedTroops) {
                const damage = deployedTroops[type] * damageRatio;
                totalTroops[type] = Math.max(0, totalTroops[type] - Math.floor(damage));
                deployedTroops[type] = Math.max(0, deployedTroops[type] - Math.floor(damage));
            }
        }

        // Check if battle has ended
        function checkBattleEnd() {
            const playerTotal = calculateTotalTroops(gameState.playerTroops);
            const enemyTotal = calculateTotalTroops(gameState.enemyTroops);
            
            if (playerTotal <= 0 && enemyTotal <= 0) {
                addToLog("<span class='defeat'>战斗结束! 双方军队同归于尽!</span>");
                endBattle(false);
            } else if (playerTotal <= 0 || gameState.playerTroops.morale <= 0) {
                addToLog("<span class='defeat'>战斗结束! 你的军队被击败了!</span>");
                endBattle(false);
            } else if (enemyTotal <= 0 || gameState.enemyTroops.morale <= 0) {
                addToLog("<span class='victory'>战斗结束! 你取得了胜利!</span>");
                endBattle(true);
            }
        }

        // End battle
        function endBattle(victory) {
            if (victory) {
                gameState.victories++;
                gameState.currentBattle.completed = true;
                gameState.battlesCompleted++;
                
                // Gain resources from victory
                const resources = Math.floor(calculateTotalTroops(gameState.enemyTroops) * 0.2);
                const infantryGain = Math.floor(resources * 0.4);
                const cavalryGain = Math.floor(resources * 0.3);
                const archersGain = Math.floor(resources * 0.3);
                
                gameState.playerTroops.infantry += infantryGain;
                gameState.playerTroops.cavalry += cavalryGain;
                gameState.playerTroops.archers += archersGain;
                
                addToLog(`<span class='reinforcement'>从敌军获得资源: 步兵 +${infantryGain}, 骑兵 +${cavalryGain}, 弓箭手 +${archersGain}</span>`);
            } else {
                gameState.defeats++;
            }
            
            // Next day
            gameState.campaignDay++;
            
            // Daily reinforcements
            const reinforcements = calculateReinforcements(gameState.selectedKingdom);
            gameState.playerTroops.infantry += reinforcements.infantry;
            gameState.playerTroops.cavalry += reinforcements.cavalry;
            gameState.playerTroops.archers += reinforcements.archers;
            
            // Morale recovery
            gameState.playerTroops.morale = Math.min(100, gameState.playerTroops.morale + 5);
            
            // Update campaign stats
            updateCampaignStats();
            
            // Check campaign completion
            if (gameState.battlesCompleted >= gameState.campaignLocations.length) {
                showCampaignResult(true);
            } else if (calculateTotalTroops(gameState.playerTroops) <= 0) {
                showCampaignResult(false);
            } else {
                // Return to campaign map
                setTimeout(() => {
                    showScreen('campaign-map-screen');
                }, 2000);
            }
        }

        // Calculate daily reinforcements
        function calculateReinforcements(kingdom) {
            const baseAmount = 200 + Math.floor(Math.random() * 300);
            const ratios = kingdoms[kingdom].reinforcement;
            
            return {
                infantry: Math.floor(baseAmount * ratios.infantry),
                cavalry: Math.floor(baseAmount * ratios.cavalry),
                archers: Math.floor(baseAmount * ratios.archers)
            };
        }

        // Update campaign stats
        function updateCampaignStats() {
            document.getElementById('campaign-day').textContent = gameState.campaignDay;
            document.getElementById('battles-completed').textContent = gameState.battlesCompleted;
            document.getElementById('victories').textContent = gameState.victories;
            document.getElementById('defeats').textContent = gameState.defeats;
        }

        // Show campaign result
        function showCampaignResult(victory) {
            const resultScreen = document.getElementById('campaign-end-screen');
            const title = document.getElementById('campaign-result-title');
            const details = document.getElementById('campaign-result-details');
            
            if (victory) {
                title.textContent = "战役胜利! (Campaign Victory!)";
                details.innerHTML = `
                    <p>你成功完成了所有战斗并统一了三国!</p>
                    <p>You have completed all battles and unified the Three Kingdoms!</p>
                    <p>战役天数: ${gameState.campaignDay}</p>
                    <p>胜利次数: ${gameState.victories}</p>
                    <p>失败次数: ${gameState.defeats}</p>
                    <p class='victory'>光荣属于 ${kingdoms[gameState.selectedKingdom].name}!</p>
                `;
            } else {
                title.textContent = "战役失败 (Campaign Defeat)";
                details.innerHTML = `
                    <p>你的军队已经被消灭，战役结束了。</p>
                    <p>Your army has been destroyed. The campaign is over.</p>
                    <p>战役天数: ${gameState.campaignDay}</p>
                    <p>胜利次数: ${gameState.victories}</p>
                    <p>失败次数: ${gameState.defeats}</p>
                    <p class='defeat'>${kingdoms[gameState.selectedKingdom].name} 的梦想破灭了...</p>
                `;
            }
            
            showScreen('campaign-end-screen');
        }

        // End campaign early
        function endCampaign() {
            showCampaignResult(false);
        }

        // Add message to battle log
        function addToLog(message) {
            const log = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.innerHTML = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>
